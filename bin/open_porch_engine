#!/usr/bin/env ruby
require "rubygems"
require 'bundler'
require 'net/pop'
require 'yaml'
require 'logger'
require 'iconv'

Bundler.setup
Bundler.require(:pop3)

require 'postageapp/mailer'

# ======= Initialize =============================================================

# Request a lock on a file to make sure only one instance of this scrip is running
LOCK_FILE = File.expand_path('../tmp/pids/open_porch.lock', File.dirname(__FILE__))
fh = File.open(LOCK_FILE, File::RDWR|File::CREAT)
unless fh.flock(File::LOCK_EX|File::LOCK_NB)
  puts 'Already running. Bye!'
  fh.close
  exit(0) 
end


# Set default environment
RAILS_ENV = (ENV['RAILS_ENV'] || 'development').dup unless defined?(RAILS_ENV)


# Establish a database connection
db_file = File.expand_path('../config/database.yml', File.dirname(__FILE__))
db_config = YAML::load(File.open(db_file))[RAILS_ENV]
ActiveRecord::Base.establish_connection(db_config)


# Load OpePorch configuration
require File.expand_path("../config/initializers/open_porch.rb", File.dirname(__FILE__))


# Setup logging
log_file = File.expand_path("../log/pop3_#{RAILS_ENV}.log", File.dirname(__FILE__))
ActiveRecord::Base.logger = Logger.new(log_file)



# Load models
require File.expand_path("../config/initializers/email_regex.rb", File.dirname(__FILE__))
Dir.glob(File.expand_path("../app/models/*.rb", File.dirname(__FILE__))).each do |file|
  next if %w{address.rb user_authority_check.rb}.include?(File.basename(file))
  require file
end


# Load user mailer
ActionMailer::Base.view_paths = File.expand_path("../app/views", File.dirname(__FILE__))
require File.expand_path("../app/mailers/user_mailer.rb", File.dirname(__FILE__))


# ======= Main =============================================================

# Send all scheduled issues
unsent_issues = Issue.scheduled_before(Time.now).all
puts "Found #{unsent_issues.length} unsent issues."
unsent_issues.each do |issue|
  issue.send!
end

# Parse all new messages from POP3 server
EmailMessage.create_from_pop3


# ======= Cleanup =============================================================

# Release lock
fh.flock(File::LOCK_UN)
fh.close
  